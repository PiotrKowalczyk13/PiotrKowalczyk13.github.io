<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        canvas {
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
</head>
<body onload="startGame()">
    <div style="font-size: large; text-align:right; width:66%">
        SCORE:
    </div>
    <div style="font-size: large; text-align:right; width:66%" id="display">
        Display score here
    </div>
    <script src="Objects.js"></script>
    <script src="Controls.js"></script>
    <script src="Stats.js"></script>
    <script src="Rules.js"></script>
    <script>

        var player;
        var horizontalPlatform;
        var myBallArray = [];
        var tilesArray = [];
        let ctx;
        var background = new Image();

        var lowest = 150;
        var countB = 0;
        var verticalPlatform = null;
        var mode = false;
        var block;
        var bonusArray = [];
        var isX2Active = false;
        var x2Timer;
        var isX5Active = false;
        var x5Timer;
        var startingSize;
        var isSizeUpgrActive = false;
        var sizeUpgrTimer;
        var isSizeDwngrActive = false;
        var sizeDwngTimer;
        var isDirectionsActive = false;
        var dirTimer;

        var score = 0;
        var time;

        var tempBallSpeedX = [];
        var tempBallSpeedY = [];
        var keyPressed = false;
        var gamePaused = false;

        function startGame() { //TODO: better prompts, annoying input so far
            background.src = "background.jpg";
            document.getElementById('buttons').style.display = 'none';
            player = prompt("Please enter your nickname.", "Nickname");
            if (player == null) {
                player = "User";
            }

            if (confirm("Do you want additional layers of tiles showing up or should tiles just fill the gaps?")) {
                mode = true;
            }

            if (confirm('Do you want second, vertical platform?')) {
                verticalPlatform = new platformVertical(23, 128, 0, 300);
                document.getElementById('upButton').style.display = 'none';
                document.getElementById('downButton').style.display = 'none';
            }
            else {
                document.getElementById('upButton').style.display = 'none';
                document.getElementById('downButton').style.display = 'none';
            }

            window.alert("Press 'Start' when you are ready.");
            time = 0;
            horizontalPlatform = new platformHorizontal(128, 23, 256, 450);
            startingSize = horizontalPlatform.width;
            myBallArray.push(new ball());
            let counter = 0;
            for (let i = 50; i < 130; i = i + 21) {
                for (let j = 65; j < 575; j = j + 51) {
                    tilesArray.push(new tile(j, i));
                    counter++;
                }
            }
            myGameArea.start();
            document.getElementById('display').innerHTML = score;
            pause();
        }

        var myGameArea = {
            canvas: document.createElement("canvas"),
            start: function () {
                this.canvas.width = 640;
                this.canvas.height = 480;
                this.context = this.canvas.getContext("2d");
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.interval = setInterval(updateGameArea, 20);
                this.timerInterval = setInterval(timer, 1000);
                window.addEventListener('keydown', function (e) {
                    myGameArea.key = e.keyCode;
                    keyPressed = true;
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.key = false;
                })
            },
            clear: function () {
                this.context.globalAlpha = 0.4;
                this.context.drawImage(background, 0, 0);
                this.context.globalAlpha = 1;
            }
        }

        function updateGameArea() { //TODO: make functions to split this abomination
            myGameArea.clear();
            if (myGameArea.key) {
                if (myGameArea.key == 37) { moveleft(); }
                if (myGameArea.key == 39) { moveright(); }
                if (myGameArea.key == 38) { moveup(); }
                if (myGameArea.key == 40) { movedown(); }
            }
            else {
                if (keyPressed) {
                    clearmove();
                    keyPressed = false;
                }
            }
            if (gamePaused) {
                horizontalPlatform.speedX = 0;
                if (verticalPlatform) {
                    verticalPlatform.speedY = 0;
                }
            }
            if (verticalPlatform) {
                horizontalPlatform.newPosVer(verticalPlatform);
                horizontalPlatform.update();
                verticalPlatform.newPos(horizontalPlatform);
                verticalPlatform.update();
                for (let i = 0; i < myBallArray.length; i++) {
                    myBallArray[i].checkHorizontalPlatform(horizontalPlatform);
                    myBallArray[i].checkVerticalPlatform(verticalPlatform);
                }
            }
            else {
                horizontalPlatform.newPos();
                horizontalPlatform.update();
                for (let i = 0; i < myBallArray.length; i++) {
                    myBallArray[i].checkHorizontalPlatform(horizontalPlatform);
                }
            }
            var checkCollision;
            for (let i = 0; i < tilesArray.length; i++) {
                tilesArray[i].update();
                for (let j = 0; j < myBallArray.length; j++) {
                    checkCollision = myBallArray[j].checkCollisionTile(tilesArray[i]);
                    if (checkCollision == true) {
                        if (tilesArray[i].type == 'B') {
                            countB++;
                        }
                        else {
                            randomBonus(tilesArray[i].x, tilesArray[i].y);
                        }
                        tilesArray.splice(i, 1);
                        i--;
                        let toAdd = 1;
                        if (isX2Active) {
                            toAdd *= 2; 
                        }
                        if (isX5Active) {
                            toAdd *= 5;
                        }
                        score += toAdd;
                        break;
                    }
                }
            }
            if (countB >= 5) {
                myBallArray.push(new ball());
                countB = 0;
            }
            for (let i = 0; i < bonusArray.length; i++) {
                bonusArray[i].update();
                checkCollision = bonusArray[i].isCaught(horizontalPlatform);
                if (checkCollision == true) {
                    if (bonusArray[i].type == "x2") {
                        isX2Active = true;
                        x2Timer = time;
                    }
                    else if (bonusArray[i].type == "x5") {
                        isX5Active = true;
                        x5Timer = time;
                    } else if (bonusArray[i].type == "sizePlus") {
                        if (isSizeDwngrActive) {
                            isSizeDwngrActive = false;
                            horizontalPlatform.width = startingSize;
                        }
                        else {
                            isSizeUpgrActive = true;
                            horizontalPlatform.width = startingSize * 1.2;
                            if (horizontalPlatform.x + horizontalPlatform.width > myGameArea.canvas.width) {
                                horizontalPlatform.x = myGameArea.canvas.width - horizontalPlatform.width;
                            }
                        }
                        sizeUpgrTimer = time;
                    } else if (bonusArray[i].type == "sizeMinus") {
                        if (isSizeUpgrActive) {
                            isSizeUpgrActive = false;
                            horizontalPlatform.width = startingSize;
                            if (horizontalPlatform.x + horizontalPlatform.width > myGameArea.canvas.width) {
                                horizontalPlatform.x = myGameArea.canvas.width - horizontalPlatform.width;
                            }
                        }
                        else {
                            isSizeDwngrActive = true;
                            horizontalPlatform.width = startingSize * 0.8;
                        }
                        sizeDwngTimer = time;
                    } else {
                        isDirectionsActive = true;
                        dirTimer = time;
                    }
                    bonusArray.splice(i, 1);
                    i--;
                }
                else if (bonusArray[i].y > horizontalPlatform.y + horizontalPlatform.height) {
                    bonusArray.splice(i, 1);
                    i--;
                }
            }
            checkBonusTimers();
            for (let i = 0; i < myBallArray.length; i++) {
                myBallArray[i].newPos();
                myBallArray[i].update();
                myBallArray[i].checkBallCollision();
                var toDelete = myBallArray[i].checkForDelete();
                if (toDelete == true) {
                    myBallArray.splice(i, 1)
                    i--;
                }
            }
            if (mode == false) {
                if (time % 5 == 0 || tilesArray.length < 5) {
                    modeOne();
                }
            }
            else {
                if (time % 30 == 0 && time != 0 && block == false) {
                    modeTwo();
                    block = true;
                }
                else if (time % 30 != 0) {
                    block = false;
                }
            }
            displayScore();
            if (myBallArray.length <= 0) {
                gameOver();
            }
        }

        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }

    </script>
    <div style="text-align:center;width:auto;" id="upButton">
        <button style="width: 100px" onmousedown="moveup()" onmouseup="clearmove()" ontouchstart="moveup()">UP</button>
    </div>
    <div style="text-align:center;width:auto;" id="buttons">
        <button style="width: 100px" onmousedown="moveleft()" onmouseup="clearmove()" ontouchstart="moveleft()">LEFT</button>
        <button style="width: 100px" onmousedown="moveright()" onmouseup="clearmove()" ontouchstart="moveright()">RIGHT</button>
    </div>
    <div style="text-align:center;width:auto;" id="downButton">
        <button style="width: 100px" onmousedown="movedown()" onmouseup="clearmove()" ontouchstart="movedown()">DOWN</button>
    </div><br><br>
    <div style="text-align:center;width:auto;">
        <button style="width: 100px" onclick="pause()">PAUSE</button>
        <button style="width: 100px" onclick="start()">START</button><br><br>
    </div><br><br>
    <div style="text-align:center;width:auto;" id="showStats">
        <button style="width: 100px" onclick="showStats()">STATS</button>
    </div>
</body>
</html>
