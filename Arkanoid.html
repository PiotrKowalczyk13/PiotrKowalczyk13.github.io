<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        canvas {
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
</head>
<body onload="startGame()">
    <div style="font-size: large; text-align:right; width:63%">
        SCORE:
    </div>
    <div style="font-size: large; text-align:right; width:63%" id="display">
        Display score here
    </div>
    <script src="Objects.js"></script>
    <script src="Controls.js"></script>
    <script src="Stats.js"></script>
    <script>

        var player;
        var time;
        var horizontalPlatform;
        var verticalPlatform = null;
        var myBallArray = [];
        var keyPressed = false;
        var gamePaused = false;
        var tilesArray
        var tempBallSpeedX = [];
        var tempBallSpeedY = [];
        var score = 0;
        let ctx;
        var countB = 0;
        var background = new Image();
        var mode = false;
        var block;
        var lowest = 100;

        function startGame() {
            background.src = "background.jpg";
            document.getElementById('buttons').style.display = 'none';
            player = prompt("Please enter your nickname.", "Nickname");
            if (player == null) {
                player = "User";
            }

            if (confirm("Do you want additional layers of tiles showing up or should tiles just fill the gaps?")) {
                mode = true;
            }

            if (confirm('Do you want second, vertical platform?')) {
                verticalPlatform = new platformVertical(20, 100, 0, 300);
                document.getElementById('upButton').style.display = 'none';
                document.getElementById('downButton').style.display = 'none';
            }
            else {
                document.getElementById('upButton').style.display = 'none';
                document.getElementById('downButton').style.display = 'none';
            }

            window.alert("Press 'Start' when you are ready.");
            time = 0;
            horizontalPlatform = new platformHorizontal(100, 20, 200, 480);
            myBallArray.push(new ball());
            tilesArray = new Array(30);
            let counter = 0;
            for (let i = 1; i < 40; i = i + 17) {
                for (let j = 2; j < 453; j = j + 50) {
                    tilesArray[counter] = new tile(j, i);
                    counter++;
                }
            }
            myGameArea.start();
            document.getElementById('display').innerHTML = score;
            pause();
        }

        var myGameArea = {
            canvas: document.createElement("canvas"),
            start: function () {
                this.canvas.width = 500;
                this.canvas.height = 500;
                this.context = this.canvas.getContext("2d");
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.interval = setInterval(updateGameArea, 20);
                this.timerInterval = setInterval(timer, 1000);
                window.addEventListener('keydown', function (e) {
                    myGameArea.key = e.keyCode;
                    keyPressed = true;
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.key = false;
                })
            },
            clear: function () {
                this.context.fillStyle = 'rgba(240, 240, 240, 0.5)';
                this.context.drawImage(background, 0, 0);
            }
        }

        function modeOne() {
            if (tilesArray.length < 5) {
                let counter = 0;
                let tilesToGenerate = Math.floor(Math.random() * (20 - 1 + 1) + 1);
                while (tilesToGenerate > 0) {
                    for (let i = 1; i < 40; i = i + 17) {
                        for (let j = 2; j < 453; j = j + 50) {
                            if (tilesArray[counter] == null) {
                                let random = Math.floor(Math.random() * (100 - 1 + 1) + 1);
                                if (random < 20) {
                                    tilesArray[counter] = new tile(j, i);
                                    tilesToGenerate--;
                                    if (tilesArray.length >= 25) {
                                        return;
                                    }
                                }
                            }
                            counter++;
                        }
                    }
                }
            }
            else if (tilesArray.length < 25 && tilesArray.length >= 5) {
                let counter = 0;
                for (let i = 1; i < 40; i = i + 17) {
                    for (let j = 2; j < 453; j = j + 50) {
                        if (tilesArray[counter] == null) {
                            let random = Math.floor(Math.random() * (100 - 1 + 1) + 1);
                            if (random < 10) {
                                tilesArray[counter] = new tile(j, i);
                                if (tilesArray.length >= 25) {
                                    return;
                                }
                            }
                        }
                        counter++;
                    }
                }
                
            }
        }

        function modeTwo() {
            for (let i = 0; i < tilesArray.length; i++) {
                tilesArray[i].y += 17;
            }
            let j = 2;
            for (let i = 0; i < 10; i++) {
                tilesArray.push(new tile(j, 1));
                j += 50;
            }
            let lowest = 0;
            if (verticalPlatform) {
                for (let i = 0; i < tilesArray.length; i++) {
                    if (tilesArray[i].tileCollision(verticalPlatform)) {
                        verticalPlatform.x = tilesArray[i].x + tilesArray[i].height + 3;
                        if (verticalPlatform.x + verticalPlatform.height > myGameArea.clear.height) {
                            gameOver();
                        }
                    }
                    if (tilesArray[i].tileCollision(horizontalPlatform)) {
                        gameOver();
                    }
                    if (tilesArray[i].x + tilesArray[i].height > lowest) {
                        lowest = tilesArray[i].x + tilesArray[i].height + 60;
                    }
                }
            }
            else {
                for (let i = 0; i < tilesArray.length; i++) {
                    if (tilesArray[i].tileCollision(horizontalPlatform)) {
                        gameOver();
                    }
                    if (tilesArray[i].x + tilesArray[i].height > lowest) {
                        lowest = tilesArray[i].x + tilesArray[i].height + 60;
                    }
                }
            }
        }

        function updateGameArea() {
            myGameArea.clear();
            if (myGameArea.key) {
                if (myGameArea.key == 37) { moveleft(); }
                if (myGameArea.key == 39) { moveright(); }
                if (myGameArea.key == 38) { moveup(); }
                if (myGameArea.key == 40) { movedown(); }
            }
            else {
                if (keyPressed) {
                    clearmove();
                    keyPressed = false;
                }
            }
            if (gamePaused) {
                horizontalPlatform.speedX = 0;
                if (verticalPlatform) {
                    verticalPlatform.speedY = 0;
                }
            }
            if (verticalPlatform) {
                horizontalPlatform.newPosVer(verticalPlatform);
                horizontalPlatform.update();
                verticalPlatform.newPos(horizontalPlatform);
                verticalPlatform.update();
                for (let i = 0; i < myBallArray.length; i++) {
                    myBallArray[i].checkHorizontalPlatform(horizontalPlatform);
                    myBallArray[i].checkVerticalPlatform(verticalPlatform);
                }
            }
            else {
                horizontalPlatform.newPos();
                horizontalPlatform.update();
                for (let i = 0; i < myBallArray.length; i++) {
                    myBallArray[i].checkHorizontalPlatform(horizontalPlatform);
                }
            }
            var checkCollision;
            for (let i = 0; i < tilesArray.length; i++) {
                tilesArray[i].update();
                for (let j = 0; j < myBallArray.length; j++) {
                    checkCollision = myBallArray[j].checkCollisionTile(tilesArray[i]);
                    if (checkCollision == true) {
                        if (tilesArray[i].type == 'B') {
                            countB++;
                        }
                        tilesArray.splice(i, 1)
                        i--;
                        score++;
                    }
                }
            }
            if (countB >= 5) {
                myBallArray.push(new ball());
                countB = 0;
            }
            for (let i = 0; i < myBallArray.length; i++) {
                myBallArray[i].newPos();
                myBallArray[i].update();
                myBallArray[i].checkBallCollision();
                var toDelete = myBallArray[i].checkForDelete();
                if (toDelete == true) {
                    myBallArray.splice(i, 1)
                    i--;
                }
            }
            if (mode == false) {
                if (time % 5 == 0 || tilesArray.length < 5) {
                    modeOne();
                }
            }
            else {
                if (time % 30 == 0 && time != 0 && block == false) {
                    modeTwo();
                    block = true;
                }
                else if (time % 30 != 0) {
                    block = false;
                }
            }
            displayScore();
            if (myBallArray.length <= 0) {
                gameOver();
            }
        }

        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }

    </script>
    <div style="text-align:center;width:auto;" id="upButton">
        <button style="width: 100px" onmousedown="moveup()" onmouseup="clearmove()" ontouchstart="moveup()">UP</button>
    </div>
    <div style="text-align:center;width:auto;" id="buttons">
        <button style="width: 100px" onmousedown="moveleft()" onmouseup="clearmove()" ontouchstart="moveleft()">LEFT</button>
        <button style="width: 100px" onmousedown="moveright()" onmouseup="clearmove()" ontouchstart="moveright()">RIGHT</button>
    </div>
    <div style="text-align:center;width:auto;" id="downButton">
        <button style="width: 100px" onmousedown="movedown()" onmouseup="clearmove()" ontouchstart="movedown()">DOWN</button>
    </div><br><br>
    <div style="text-align:center;width:auto;">
        <button style="width: 100px" onclick="pause()">PAUSE</button>
        <button style="width: 100px" onclick="start()">START</button><br><br>
    </div><br><br>
    <div style="text-align:center;width:auto;" id="showStats">
        <button style="width: 100px" onclick="showStats()">STATS</button>
    </div>
</body>
</html>
